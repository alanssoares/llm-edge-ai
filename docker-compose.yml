# This file is generated by generate-compose.py
# To regenerate: python3 generate-compose.py --devices 1 --mqtt-enabled
# Number of devices: 1
# MQTT telemetry: enabled

services:
  mqtt-broker:
    image: eclipse-mosquitto:1.6
    container_name: mqtt-broker
    hostname: mqtt-broker
    ports:
    - 1883:1883
    - 9001:9001
    volumes:
    - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    - mosquitto_data:/mosquitto/data
    - mosquitto_logs:/mosquitto/log
    networks:
    - edge-network
    restart: unless-stopped
  iot-device-image:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: '1'
    image: iot-device-simulator:latest
    command:
    - echo
    - This service builds the shared image for edge device simulation
  edge-device-01:
    image: iot-device-simulator:latest
    container_name: edge-device-01
    hostname: edge-device-01
    environment:
    - DEVICE_NAME=edge-device-01
    - DEVICE_ID=00:0f:00:70:91:0a
    - MQTT_BROKER=mqtt-broker
    - MQTT_PORT=1883
    - ENABLE_LLM=true
    - LLM_MODEL_NAME=microsoft/Phi-3.5-mini-instruct
    - LLM_INFERENCE_INTERVAL=5
    - LLM_MAX_LENGTH=512
    - LLM_TEMPERATURE=0.7
    volumes:
    - ./config:/etc/edge-device:ro
    - ./dataset:/app/dataset:ro
    - ./metrics/edge-device-01:/app/metrics
    networks:
    - edge-network
    depends_on:
    - mqtt-broker
    - iot-device-image
    restart: unless-stopped
volumes:
  mosquitto_data:
    driver: local
  mosquitto_logs:
    driver: local
networks:
  edge-network:
    driver: bridge
    ipam:
      config:
      - subnet: 172.20.0.0/16
